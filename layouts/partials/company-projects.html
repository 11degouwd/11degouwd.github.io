{{/* 
  Company Projects partial - displays project cards filtered by company
  
  Parameters:
  - companySlug: slug of the company to filter by (required)
  - companyName: display name of the company (optional, auto-detected if not provided)
  - showCompanyName: show company name on each project card - default: false
  - showTitle: show "Projects at {Company}" heading - default: true
  - tagFilter: comma-separated list of tags to filter by (case-insensitive, OR operation) - default: none
  - minWeight: minimum project weight to display (1-5, where 1 is default) - default: 1
*/}}

{{ $companySlug := .companySlug }}

{{ $showCompanyName := false }}
{{ if isset . "showCompanyName" }}
  {{ if or (eq .showCompanyName "true") (eq .showCompanyName true) }}
    {{ $showCompanyName = true }}
  {{ end }}
{{ end }}

{{ $companyName := .companyName | default "" }}
{{ if not $companyName }}
  {{- $companyPage := site.GetPage (printf "companies/%s" $companySlug) -}}
  {{- if $companyPage -}}
    {{ $companyName = $companyPage.Title }}
  {{- else -}}
    {{ $companyName = $companySlug | humanize | title }}
  {{- end -}}
{{ end }}

{{ $showTitle := true }}
{{ if isset . "showTitle" }}
  {{ if or (eq .showTitle "false") (eq .showTitle false) }}
    {{ $showTitle = false }}
  {{ end }}
{{ end }}

{{ $projects := where site.RegularPages "Section" "portfolio" }}
{{ $projectsList := where $projects ".Params.company" $companySlug }}

{{/* Filter by minimum weight */}}
{{ $minWeight := .minWeight | default 1 }}
{{ if gt $minWeight 1 }}
  {{ $filteredProjects := slice }}
  {{ range $projectsList }}
    {{ $projectWeight := .Params.weight | default 1 }}
    {{ if ge $projectWeight $minWeight }}
      {{ $filteredProjects = $filteredProjects | append . }}
    {{ end }}
  {{ end }}
  {{ $projectsList = $filteredProjects }}
{{ end }}

{{/* Filter by tags if provided */}}
{{ $tagFilter := .tagFilter | default "" }}
{{ if $tagFilter }}
  {{ $filteredProjects := slice }}
  {{ $filterTags := split $tagFilter "," }}
  {{ range $projectsList }}
    {{ $project := . }}
    {{ $hasTag := false }}
    {{ range $filterTags }}
      {{ $filterTag := trim . " " | lower }}
      {{ range $project.Params.tags }}
        {{ if eq (. | lower) $filterTag }}
          {{ $hasTag = true }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if $hasTag }}
      {{ $filteredProjects = $filteredProjects | append $project }}
    {{ end }}
  {{ end }}
  {{ $projectsList = $filteredProjects }}
{{ end }}

<section id="portfolio">
  {{ if gt (len $projectsList) 0 }}
    {{ if $showTitle }}
      <h2 class="mt-5 mb-3">Projects at {{ $companyName }}:</h2>
    {{ end }}
  {{ end }}
      

  {{ partial "project-cards.html" (dict
    "projectsList" $projectsList
    "showCompanyName" $showCompanyName
  ) }}
</section>