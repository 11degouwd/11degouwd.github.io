{{/* 
  Project Cards partial - displays a grid of project cards
  
  Parameters:
  - projectsList: array of project pages to display (required)
  - showCompanyName: show company name on each project card - default: true
  - cardHeight: height of the card image in pixels (min: 150px, max: 400px) - default: 400
  - excludeFolders: comma-separated list of subfolder names to exclude (e.g., "personal,drafts") - default: none
*/}}

{{ $projectsList := .projectsList }}
{{ $excludeFolders := .excludeFolders | default "" }}

{{/* Filter out excluded folders if provided */}}
{{ if $excludeFolders }}
  {{ $filteredProjects := slice }}
  {{ $excludeList := split $excludeFolders "," }}
  {{ range $projectsList }}
    {{ $project := . }}
    {{ $exclude := false }}
    {{/* Check if project is in an excluded folder */}}
    {{ range $excludeList }}
      {{ $excludeFolder := trim . " " }}
      {{ if in $project.File.Dir $excludeFolder }}
        {{ $exclude = true }}
      {{ end }}
    {{ end }}
    {{ if not $exclude }}
      {{ $filteredProjects = $filteredProjects | append $project }}
    {{ end }}
  {{ end }}
  {{ $projectsList = $filteredProjects }}
{{ end }}
{{ $cardImgHeight := .cardImgHeight | default 200 }}
{{ $cardHeight := .cardHeight | default 500 }}
{{ $cardSummaryHeightMin := .cardSummaryHeightMin | default 32 }}
{{ $cardSummaryHeightMax := .cardSummaryHeightMax | default 150 }}

{{ if lt $cardImgHeight 150 }}{{ $cardImgHeight = 150 }}{{ end }}
{{ if gt $cardImgHeight 400 }}{{ $cardImgHeight = 400 }}{{ end }}

{{ if lt $cardHeight 450 }}{{ $cardHeight = 450 }}{{ end }}
{{ if gt $cardHeight 600 }}{{ $cardHeight = 600 }}{{ end }}

{{ $cardPadding := 32 }}
{{ $cardImgPadding := 12 }}
{{ $cardTitleHeight := 42 }}
{{ $cardSubtitleHeight := 38 }}
{{ $cardTagHeight := 50 }}
{{ $imgHeightMax := sub $cardHeight (add $cardPadding $cardImgPadding $cardTitleHeight $cardSubtitleHeight $cardTagHeight $cardSummaryHeightMin) }}
{{ $summaryHeightMax := sub $cardHeight (add $cardPadding $cardImgPadding $cardTitleHeight $cardSubtitleHeight $cardTagHeight $cardImgHeight) }}

{{ $summaryHeight := $cardSummaryHeightMax }}

{{ if lt $imgHeightMax $cardImgHeight }}
  {{/*  Our card is too small for the desired image size -> shrink the image  */}}
  {{ $cardImgHeight = $imgHeightMax }}
  {{ $summaryHeight = $cardSummaryHeightMin }}
{{ else }}
  {{/*  Our card is good, just need to check max summary length  */}}
{{ $summaryHeight = $summaryHeightMax }}
  {{ if gt $summaryHeight $cardSummaryHeightMax }}{{ $summaryHeight = $cardSummaryHeightMax }}{{ end }}
{{ end }}

{{ $showCompanyName := true }}
{{ if isset . "showCompanyName" }}
  {{ if or (eq .showCompanyName "false") (eq .showCompanyName false) }}
    {{ $showCompanyName = false }}
  {{ end }}
{{ end }}

<section id="portfolio-cards" style="
  --project-img-height: {{ $cardImgHeight }}px; 
  --max-card-height: {{ $cardHeight }}px;
  --max-summary-height: {{ $summaryHeight }}px;">
  {{ if gt (len $projectsList) 0 }}
    <div class="project-cards-grid">
      {{ range $projectsList }}
        {{ $companySlug := .Params.companySlug }}

        <a href="{{ .RelPermalink }}" 
          class="project-card"
          data-tags="{{ delimit .Params.tags " " }}">
          
          <!-- Project thumbnail -->
          {{ with .Resources.GetMatch .Params.image }}
            {{ $thumb := .Fill "400x400 Center" }}
            <img
              src="{{ $thumb.RelPermalink }}"
              width="{{ $thumb.Width }}"
              height="{{ $thumb.Height }}"
              loading="lazy"
              class="project-img"
            />
          {{ end }}

          <!-- Project content -->
          <div class="project-content">
            <h3>{{ .Title }}</h3>

            {{ if $showCompanyName }}
              {{ $companyName := "" }}
              {{- $companyPage := site.GetPage (printf "companies/%s" $companySlug) -}}
              {{- if $companyPage -}}
                {{ $companyName = $companyPage.Title }}
              {{- else -}}
                {{ $companyName = $companySlug | humanize | title }}
              {{- end -}}
              <p class="project-company">Company: {{ $companyName }}</p>
            {{ end }}

            <p class="project-summary">{{ .Params.summary | truncate 250 }}</p>

            <!-- Tags -->
            <div class="project-tags">
              {{ range .Params.tags }}
                <button class="tag-btn" data-tag="{{ . }}" type="button">{{ . }}</button>
              {{ end }}
            </div>
          </div>
        </a>
      {{ end }}
    </div>
  {{ end }}
</section>