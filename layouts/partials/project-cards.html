{{/* 
  Project Cards partial - displays a grid of project cards
  
  Parameters:
  - projectsList: array of project pages to display (required)
  - showCompanyName: show company name on each project card - default: true
  - cardHeight: height of the card image in pixels (min: 150px, max: 400px) - default: 400
  - excludeFolders: comma-separated list of subfolder names to exclude (e.g., "personal,drafts") - default: none
*/}}

{{ $projectsList := .projectsList }}
{{ $excludeFolders := .excludeFolders | default "" }}

{{/* Filter out excluded folders if provided */}}
{{ if $excludeFolders }}
  {{ $filteredProjects := slice }}
  {{ $excludeList := split $excludeFolders "," }}
  {{ range $projectsList }}
    {{ $project := . }}
    {{ $exclude := false }}
    {{/* Check if project is in an excluded folder */}}
    {{ range $excludeList }}
      {{ $excludeFolder := trim . " " }}
      {{ if in $project.File.Dir $excludeFolder }}
        {{ $exclude = true }}
      {{ end }}
    {{ end }}
    {{ if not $exclude }}
      {{ $filteredProjects = $filteredProjects | append $project }}
    {{ end }}
  {{ end }}
  {{ $projectsList = $filteredProjects }}
{{ end }}
{{ $cardHeight := .cardHeight | default 150 }}

{{ if lt $cardHeight 150 }}{{ $cardHeight = 150 }}{{ end }}
{{ if gt $cardHeight 400 }}{{ $cardHeight = 400 }}{{ end }}

{{ $showCompanyName := true }}
{{ if isset . "showCompanyName" }}
  {{ if or (eq .showCompanyName "false") (eq .showCompanyName false) }}
    {{ $showCompanyName = false }}
  {{ end }}
{{ end }}

<section id="portfolio-cards" style="--project-img-height: {{ $cardHeight }}px;">
  {{ if gt (len $projectsList) 0 }}
    <div style="
      display:grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap:1.5rem;
      max-width: calc(4 * 250px + 3 * 1.5rem); 
      margin: 0 auto;">
      
      {{ range $projectsList }}
        {{ $companySlug := .Params.companySlug }}

        <a href="{{ .RelPermalink }}" 
          class="project-card"
          data-tags="{{ delimit .Params.tags " " }}"
          style="display:flex; flex-direction:column; text-align:center; height:100%;">
          
          <!-- Square thumbnail -->
          {{ with .Resources.GetMatch .Params.image }}
            {{ $thumb := .Fill "400x400 Center" }}
            <img
              src="{{ $thumb.RelPermalink }}"
              width="{{ $thumb.Width }}"
              height="{{ $thumb.Height }}"
              loading="lazy"
              class="project-img"
            />
          {{ end }}

          <!-- Project text -->
          <div style="margin-top:0.75rem; display:flex; flex-direction:column; flex-grow:1;">
            <h3 style="font-weight:600; font-size:0.9rem;">{{ .Title }}</h3>

            {{ if $showCompanyName }}
              {{ $companyName := "" }}
              {{- $companyPage := site.GetPage (printf "companies/%s" $companySlug) -}}
              {{- if $companyPage -}}
                {{ $companyName = $companyPage.Title }}
              {{- else -}}
                {{ $companyName = $companySlug | humanize | title }}
              {{- end -}}
              <p style="font-size:0.75rem; color:var(--text-secondary); margin-top:0.25rem;">Company: {{ $companyName }}</p>
            {{ end }}

            <p style="font-size:0.8rem; color:var(--text-muted); margin-top:0.5rem;">{{ .Params.summary }}</p>

            <!-- Tags -->
            <div class="project-tags" style="margin-top:auto; display:flex; flex-wrap:wrap; justify-content:center; gap:0.25rem;">
              {{ range .Params.tags }}
                <button class="tag-btn" data-tag="{{ . }}" type="button">{{ . }}</button>
              {{ end }}
            </div>
          </div>
        </a>
      {{ end }}
    </div>
  {{ end }}
</section>