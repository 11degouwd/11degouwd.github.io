{{ if .Site.Params.experience.enable | default false }}

<link rel="stylesheet" href="{{ "css/experience.css" | relURL }}">

<section id="experience" class="py-5">
  <div class="container">
    <h3 class="text-center">
      {{ .Site.Params.experience.title | default "Experience" }} 
    </h3>

    <div class="row justify-content-center">
      <div class="col-sm-12 col-md-8 col-lg-10 py-5">
        <div class="experience-container px-3 pt-2">

          <!-- Sort roles by most recent first start and currently active -->
          {{ $roles := where site.RegularPages "Section" "experience" }}
          {{ $current := where $roles ".Params.end" "==" nil }}
          {{ $current = sort $current "Params.start" "desc" }}
          {{ $past := where $roles ".Params.end" "!=" nil }}
          {{ $past = sort $past "Params.end" "desc" }}
          {{ $roles = union $current $past }}
          {{ $groups := $roles.GroupByParam "companySlug" }} 
          {{ $companies := slice }}
          
          <!-- Uses order of $roles to create a list of companies -->
          {{ range $roles }} 
            {{ $slug := .Params.companySlug }}
            {{ if not (in $companies $slug) }}
              {{ $companies = $companies | append $slug }}
            {{ end }}
          {{ end }}

          {{ if gt (len $companies) 0 }}
            <div class="experience-container-loop">

              {{ range $companies }}
                {{ $slug := . }}
                {{ $companyRoles := where $roles "Params.companySlug" $slug }}

                {{ $companyPath := path.Join "companies" $slug }}
                {{ $company := site.GetPage "section" $companyPath }}

                {{ $companyStart := index (last 1 $companyRoles) 0 }}
                {{ $companyEnd := index $companyRoles 0 }}

                <div class="experience-company">

                  {{ if $company }}
                    <div class="company-header">

                      {{ $logoPath := path.Join "images" $slug $company.Params.logo }}

                      {{ if and $company.Params.logo (fileExists (printf "static/%s" $logoPath)) }}
                        <a class="company-logo-link" href="{{ $company.RelPermalink }}">
                          <img src="{{ $logoPath | relURL }}" class="company-logo">
                        </a>
                      {{ else }}
                        <a class="company-logo-link" href="{{ $company.RelPermalink }}">
                          <img
                            src="https://ui-avatars.com/api/?name={{ $company.Title | humanize | urlquery }}&size=150&bold=true&background=DDDDDD&color=555555"
                            alt="Missing company"
                            class="company-logo">
                        </a>
                        {{ warnf "Missing logo for company: %s (expected at: %s)" $company.Title $logoPath }}
                      {{ end }}

                      <div class="company-header-text">
                        <h4 class="company-title">
                          <a href="{{ $company.RelPermalink }}">{{ $company.Title }}</a>
                        </h4>
                        <span class="company-dates">
                          ({{ $companyStart.Params.start | time.Format "Jan 2006" }} –
                          {{ with $companyEnd.Params.end }}{{ . | time.Format "Jan 2006" }}{{ else }}Present{{ end }})
                        </span>
                        <a href="{{ $company.RelPermalink }}" class="company-read-more">Read More →</a>
                      </div>
                    </div>

                  {{ else }}
                    <div class="company-header">
                      <img
                        src="https://ui-avatars.com/api/?name={{ $slug | humanize | urlquery }}&size=150&bold=true&background=DDDDDD&color=555555"
                        alt="Missing company"
                        class="company-logo">
                      <div class="company-header-text">
                        <h4 class="company-title">
                          {{ $slug | humanize | title }}
                        </h4>
                        <span class="company-dates">
                          ({{ $companyStart.Params.start | time.Format "Jan 2006" }} –
                          {{ with $companyEnd.Params.end }}{{ . | time.Format "Jan 2006" }}{{ else }}Present{{ end }})
                        </span>
                      </div>
                    </div>
                    {{ warnf "Missing company page: %s" $companyPath }}
                  {{ end }}

                  <div class="roles-list">
                    {{ range $companyRoles }}
                      <div class="role-row">
                        <div class="role-dot"></div>
                        <div class="role-body">
                          <div class="role-title">{{ .Title }}</div>
                          <div class="role-meta">
                            {{ .Params.start | time.Format "Jan 2006" }} –
                            {{ with .Params.end }}{{ . | time.Format "Jan 2006" }}{{ else }}Present{{ end }}
                            {{ with .Params.location }} · {{ . }}{{ end }}
                          </div>
                          <p class="role-summary">{{ .Params.summary | markdownify }}</p>
                        </div>
                      </div>
                    {{ end }}
                  </div>

                  {{ if $company }}
                    <div class="company-learn-more">
                      <a href="{{ $company.RelPermalink }}">Learn more about {{ $company.Title }} →</a>
                    </div>
                  {{ end }}

                </div>
              {{ end }}

            </div>
            {{ end }}

        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function () {
  function updateTimelineLines() {
    var companies = document.querySelectorAll('#experience .experience-company');
    for (var i = 1; i < companies.length; i++) {
      var prevDots = companies[i - 1].querySelectorAll('.role-dot');
      var currDots = companies[i].querySelectorAll('.role-dot');
      if (!prevDots.length || !currDots.length) continue;

      var prevLast = prevDots[prevDots.length - 1];
      var currFirst = currDots[0];
      var rolesList = companies[i].querySelector('.roles-list');
      if (!rolesList) continue;

      var prevCenter = prevLast.getBoundingClientRect().top + prevLast.getBoundingClientRect().height / 2;
      var currCenter = currFirst.getBoundingClientRect().top + currFirst.getBoundingClientRect().height / 2;

      var rlRect = rolesList.getBoundingClientRect();
      var anchorFromTop = currCenter - rlRect.top;

      rolesList.style.setProperty('--line-bottom', (rlRect.height - anchorFromTop) + 'px');
      rolesList.style.setProperty('--line-height', Math.max(0, currCenter - prevCenter) + 'px');
    }
  }

  window.addEventListener('load', function () {
    requestAnimationFrame(updateTimelineLines);
  });
  window.addEventListener('resize', updateTimelineLines);
})();
</script>
{{ end }}