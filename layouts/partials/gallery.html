{{/* 
  Gallery partial - supports page bundle resources, static images and assets images
  
  Parameters:
  - src: image pattern or directory (default: all images)
  - source: (default: "bundle")
    * "bundle": Page bundle resources (with image processing)
    * "static": Files in static/images/ (no processing, served as-is)
    * "assets": Files in assets/images/ (with image processing)
  - layout: "grid", "row", or "single" - (default: "grid")
  - cols: number of columns for grid layout - (default: "3")
  - max: maximum visible images - (default: 5)
  - showCaption: show image captions - (default: false)
  - thumbSize: thumbnail size - (default: "480x" - only for source=bundle/assets)
  - thumbQuality: thumbnail quality - (default: "60" - only for source=bundle/assets)
  - fullSize: full image size - (default: "1200x" - only for source=bundle/assets)
  - fullQuality: full image quality - (default: "85" - only for source=bundle/assets)
  - page: the page context (required when source is "bundle")
  
  Note: Static files are served directly without image processing (resize, quality).
*/}}

{{ $src := .src | default "" }}
{{ $source := .source | default "bundle" }}
{{ $layout := .layout | default "grid" }}
{{ $cols := .cols | default "3" }}
{{ $max := .max | default 5 | int }}
{{ $showCaption := .showCaption | default false }}

{{ $thumbSize := .thumbSize | default "480x" }}
{{ $thumbQuality := .thumbQuality | default "60" }}
{{ $fullSize := .fullSize | default "1200x" }}
{{ $fullQuality := .fullQuality | default "85" }}

{{ $page := .page }}
{{ $pattern := "" }}
{{ $uniqueID := "" }}
{{ $images := slice }}

{{if gt $max 5 }}{{ $max = 5 }}{{ end }}

{{/* Determine pattern and unique ID */}}
{{ if eq $src "" }}
  {{ $pattern = "*.{jpg,jpeg,svg,png,webp}" }}
  {{ if eq $source "bundle" }}
    {{ $uniqueID = $page.File.Path }}
  {{ else }}
    {{ $uniqueID = "gallery-default" }}
  {{ end }}
{{ else if strings.Contains $src "." }}
  {{ $pattern = $src }}
  {{ $uniqueID = strings.TrimSuffix (path.Ext $src) $src }}
{{ else }}
  {{ $pattern = printf "%s/*.{jpg,jpeg,svg,png,webp}" $src }}
  {{ $uniqueID = $src }}
{{ end }}

{{/* Get images based on source type */}}
{{ if eq $source "bundle" }}
  {{ $images = $page.Resources.Match $pattern }}
{{ else if eq $source "static" }}
  {{/* For static files, we need to read the directory and build paths manually */}}
  {{ $staticPath := "" }}
  {{ if eq $src "" }}
    {{ $staticPath = "static/images" }}
  {{ else if strings.Contains $src "." }}
    {{ $staticPath = printf "static/images/%s" (path.Dir $src) }}
  {{ else }}
    {{ $staticPath = printf "static/images/%s" $src }}
  {{ end }}
  
  {{ $files := slice }}
  {{ with os.ReadDir $staticPath }}
    {{ range . }}
      {{ if not .IsDir }}
        {{ $ext := path.Ext .Name | lower }}
        {{ if in (slice ".jpg" ".jpeg" ".png" ".webp" ".svg") $ext }}
          {{ $files = $files | append . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $images = $files }}
{{ else if eq $source "assets" }}
  {{/* For assets, use resources.Match */}}
  {{ $images = resources.Match (printf "images/%s" $pattern) }}
{{ end }}

{{ $galleryID := printf "gallery-%s" $uniqueID }}

<section id="gallery">
  <div
    class="gallery gallery--{{ $layout }}"
    {{ if eq $layout "grid" }}style="--gallery-cols: {{ $cols }};"{{ end }}
  >
    {{ range $i, $img := $images }}
      {{ $normalized := $img }}
      {{ $thumb := $img }}
      {{ $full := $img }}
      {{ $imgName := "" }}
      {{ $thumbPath := "" }}
      {{ $fullPath := "" }}
      
      {{ if eq $source "static" }}
        {{/* Static files don't support .Filter - use direct paths */}}
        {{ $imgName = $img.Name }}
        {{ $relPath := "" }}
        {{ if eq $src "" }}
          {{ $relPath = printf "/images/%s" $img.Name }}
        {{ else if strings.Contains $src "." }}
          {{ $relPath = printf "/images/%s/%s" (path.Dir $src) $img.Name }}
        {{ else }}
          {{ $relPath = printf "/images/%s/%s" $src $img.Name }}
        {{ end }}
        {{ $thumbPath = $relPath }}
        {{ $fullPath = $relPath }}
      {{ else }}
        {{/* Resources support .Filter */}}
        {{ $imgName = $img.Name }}
        {{ if $img.Filter }}
          {{ $normalized = $img.Filter (images.AutoOrient) }}
          {{ $thumb = $normalized.Resize (printf "%s q%s" $thumbSize $thumbQuality) }}
          {{ $full = $normalized.Resize (printf "%s q%s" $fullSize $fullQuality) }}
        {{ end }}
        {{ $thumbPath = $thumb.RelPermalink }}
        {{ $fullPath = $full.RelPermalink }}
      {{ end }}

      {{ if or  (and (eq $layout "single") (gt $i 0))
                (and (eq $layout "row") (gt $i (sub $max 1))) 
      }}
          <a
            href="{{ $fullPath }}"
            data-fancybox="{{ $galleryID }}"
            {{ if $showCaption }}data-caption="{{ $imgName | humanize }}"{{ end }}
            hidden
          >
            <img src="{{ $thumbPath }}" data-src="{{ $fullPath }}" 
              alt="{{ $imgName | humanize }}" 
              loading="lazy"   
              class="lazy-blur">
          </a>
      {{ else if or  (and (eq $layout "single") (eq $i 0))
                (and (eq $layout "row") (eq $i (sub $max 1))) 
      }}
        <a
          href="{{ $fullPath }}"
          data-fancybox="{{ $galleryID }}"
          {{ if $showCaption }}data-caption="{{ $imgName | humanize }}"{{ end }}
          class="gallery-item gallery-more"
        >
          <span class="gallery-thumb">
            <img src="{{ $thumbPath }}" data-src="{{ $fullPath }}" 
              alt="{{ $imgName | humanize }}" 
              loading="lazy"   
              class="lazy-blur">
            {{ if gt (len $images) $max }}
              <span class="gallery-more-badge">+{{ sub (len $images) $max }}</span>
            {{ end }}
          </span>
        </a>
      {{ else if eq $layout "row" }}
        {{ if lt $i (sub $max 1) }}
          <a
            href="{{ $fullPath }}"
            data-fancybox="{{ $galleryID }}"
            {{ if $showCaption }}data-caption="{{ $imgName | humanize }}"{{ end }}
            class="gallery-item"
          >
            <span class="gallery-thumb">
              <img src="{{ $thumbPath }}" data-src="{{ $fullPath }}" 
                alt="{{ $imgName | humanize }}" 
                loading="lazy"   
                class="lazy-blur">
            </span>
          </a>
        {{ end }}

      {{ else }}
        <a
          href="{{ $fullPath }}"
          data-fancybox="{{ $galleryID }}"
          {{ if $showCaption }}data-caption="{{ $imgName | humanize }}"{{ end }}
          class="gallery-item"
        >
          <span class="gallery-thumb">
            <img src="{{ $thumbPath }}" data-src="{{ $fullPath }}" 
              alt="{{ $imgName | humanize }}" 
              loading="lazy"   
              class="lazy-blur">
          </span>
        </a>
      {{ end }}

    {{ end }}
  </div>
</section>